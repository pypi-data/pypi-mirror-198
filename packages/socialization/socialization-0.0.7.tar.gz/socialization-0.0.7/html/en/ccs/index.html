<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>socialization.ccs API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>socialization.ccs</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">from .base_god_service import BaseGodService
from .base_goddess_service import BaseGoddessService
from .json_ws_active_service import JSONWebsocketActiveService
from .json_ws_passive_service import JSONWebsocketPassiveService
from .wrapped_god_service import WrappedGodService
from .wrapped_goddess_service import WrappedGoddessService
from .wrapped_goddess_db_agent import WrappedGoddessDBAgent
from ..import codes

__all__ = [&#34;BaseGodService&#34;, &#34;BaseGoddessService&#34;, &#34;JSONWebsocketActiveService&#34;, &#34;JSONWebsocketPassiveService&#34;, &#34;WrappedGodService&#34;, &#34;WrappedGoddessService&#34;, &#34;WrappedGoddessDBAgent&#34;, &#34;codes&#34;]</code></pre>
</details>
</section>
<section>
<h2 class="section-title" id="header-submodules">Sub-modules</h2>
<dl>
<dt><code class="name"><a title="socialization.ccs.base_god_service" href="base_god_service.html">socialization.ccs.base_god_service</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="socialization.ccs.base_goddess_service" href="base_goddess_service.html">socialization.ccs.base_goddess_service</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="socialization.ccs.json_ws_active_service" href="json_ws_active_service.html">socialization.ccs.json_ws_active_service</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="socialization.ccs.json_ws_passive_service" href="json_ws_passive_service.html">socialization.ccs.json_ws_passive_service</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="socialization.ccs.wrapped_god_service" href="wrapped_god_service.html">socialization.ccs.wrapped_god_service</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="socialization.ccs.wrapped_goddess_db_agent" href="wrapped_goddess_db_agent.html">socialization.ccs.wrapped_goddess_db_agent</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
<dt><code class="name"><a title="socialization.ccs.wrapped_goddess_service" href="wrapped_goddess_service.html">socialization.ccs.wrapped_goddess_service</a></code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="socialization.ccs.BaseGodService"><code class="flex name class">
<span>class <span class="ident">BaseGodService</span></span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class BaseGodService(JSONWebsocketActiveService):
    def __init__(self):
        super().__init__()
        self.codes = codes
        self.path = &#39;&#39; # possible new route path for websocket
        
    def on_open(self, ws):
        print(&#39;BaseGodService opened&#39;)
        
    # override this function to handle data
    def _handle_data_dict(self, data, ws):
        # print(f&#39;BaseGodService: _handle_data_dict received {data} at websocket {ws}&#39;)
        if data[&#39;code&#39;] == self.codes.MESSAGE_TO_CCS:
            self._handle_message_to_ccs(data, ws, self.path)
        elif data[&#39;code&#39;] == self.codes.COMMAND_TO_CCS:
            self._handle_command_to_ccs(data, ws, self.path)
        else:
            pass
    
    def _handle_message_to_ccs(self, data, ws, path):
        data[&#39;extra&#39;][&#39;origin&#39;] = self.__class__.__name__
        data[&#39;extra&#39;][&#39;type_code&#39;] += 20000

        # 3xxxx to 5xxxx
        self._send_data_to_ws(ws, self.codes.MESSAGE_FROM_CCS, **data[&#39;extra&#39;])               

    def _handle_command_to_ccs(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        if 20000 &lt;= type_code &lt;= 29999:
            self._handle_basic_command(data, ws, path)
        elif 80000 &lt;= type_code &lt;= 89999:
            self._handle_notice(data, ws, path)

        elif 90000 &lt;= type_code &lt;= 99999:
            self._handle_feature(data, ws, path)

        else:
            pass
    
    
    def _handle_basic_command(self, data, ws, path):
        pass

    def _handle_notice(self, data, ws, path):
        pass

    def _handle_feature(self, data, ws, path):
        pass
   
    def _send_ccs_operation(self, data, ws, path):
        code = data[&#39;code&#39;]
        if code == self.codes.COPERATION_GOD_RECONNECT:
            user_id = data[&#39;extra&#39;][&#39;user_id&#39;]
            password = data[&#39;extra&#39;][&#39;password&#39;]
            self._send_data_to_ws(ws, code, user_id=user_id, password=password)
        else:
            pass
        # # print(&#39;BaseGoddessService ccs_operation: &#39;, data)
        # code = data[&#39;code&#39;]
        # password = data[&#39;extra&#39;][&#39;password&#39;]
        # ccs_id = data[&#39;extra&#39;][&#39;ccs_id&#39;]
        # if code == self.codes.COPERATION_LOGIN:
        #     self._send_data_to_ws(ws, self.codes.COPERATION_LOGIN, ccs_id=ccs_id, password=password)
        # else:
        #     pass

    def _send_command_down(self, ws, type_code, **kwargs):
        self._send_data_to_ws(ws, self.codes.COMMAND_FROM_CCS, type_code=type_code, **kwargs)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="socialization.ccs.json_ws_active_service.JSONWebsocketActiveService" href="json_ws_active_service.html#socialization.ccs.json_ws_active_service.JSONWebsocketActiveService">JSONWebsocketActiveService</a></li>
</ul>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="socialization.ccs.wrapped_god_service.WrappedGodService" href="wrapped_god_service.html#socialization.ccs.wrapped_god_service.WrappedGodService">WrappedGodService</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="socialization.ccs.BaseGodService.on_open"><code class="name flex">
<span>def <span class="ident">on_open</span></span>(<span>self, ws)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def on_open(self, ws):
    print(&#39;BaseGodService opened&#39;)</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="socialization.ccs.BaseGoddessService"><code class="flex name class">
<span>class <span class="ident">BaseGoddessService</span></span>
<span>(</span><span>port=9000)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class BaseGoddessService(JSONWebsocketPassiveService):
    def __init__(self, port=9000):
        super().__init__(port=port)
        self.codes = codes

    async def _handle_data_dict(self, data, ws, path):
        # print(&#39;BaseGoddessService _handle_data_dict: &#39;, data)
        if data[&#39;code&#39;] == self.codes.MESSAGE_TO_CCS:
            await self._handle_message_to_ccs(data, ws, path)
        elif data[&#39;code&#39;] == self.codes.COMMAND_TO_CCS:
            await self._handle_command_to_ccs(data, ws, path)
        # elif data[&#39;code&#39;] == self.codes.QUERY_RESPOND_TO_CCS:
        #     await self._handle_query_respond_to_ccs(data, ws, path)
        else:
            pass

    async def _handle_message_to_ccs(self, data, ws, path):
        data[&#39;extra&#39;][&#39;origin&#39;] = self.__class__.__name__
        data[&#39;extra&#39;][&#39;type_code&#39;] += 20000

        # 3xxxx to 5xxxx
        await self._send_data_to_ws(ws, self.codes.MESSAGE_FROM_CCS, **data[&#39;extra&#39;])               

    async def _handle_command_to_ccs(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        # print(&#39;BaseGoddessService _handle_command_to_ccs: &#39;, data)
        if 20000 &lt;= type_code &lt;= 29999:
            await self._handle_basic_command(data, ws, path)
        elif 80000 &lt;= type_code &lt;= 89999:
            await self._handle_notice(data, ws, path)
        elif 90000 &lt;= type_code &lt;= 99999:
            await self._handle_feature(data, ws, path)

        else:
            pass
    
    async def _handle_basic_command(self, data, ws, path):
        pass

    async def _handle_notice(self, data, ws, path):
        pass

    async def _handle_feature(self, data, ws, path):
        pass

    async def _send_command_down(self, ws, type_code, **kwargs):
        await self._send_data_to_ws(ws, self.codes.COMMAND_FROM_CCS, type_code=type_code, **kwargs)

    async def _send_ccs_operation(self, data, ws, path):
        pass</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="socialization.ccs.json_ws_passive_service.JSONWebsocketPassiveService" href="json_ws_passive_service.html#socialization.ccs.json_ws_passive_service.JSONWebsocketPassiveService">JSONWebsocketPassiveService</a></li>
</ul>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="socialization.ccs.wrapped_goddess_service.WrappedGoddessService" href="wrapped_goddess_service.html#socialization.ccs.wrapped_goddess_service.WrappedGoddessService">WrappedGoddessService</a></li>
</ul>
</dd>
<dt id="socialization.ccs.JSONWebsocketActiveService"><code class="flex name class">
<span>class <span class="ident">JSONWebsocketActiveService</span></span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class JSONWebsocketActiveService:
    def __init__(self) -&gt; None:
        pass
    
    # new websocket, do not try to connect
    def create_websocket(self, uri, on_open=None, on_message=None, on_error=None, on_close=None):
        print(&#39;create_websocket&#39;)
        ws = websocket.WebSocketApp(uri,
            on_open=on_open or self.on_open,
            on_message=on_message or self.on_message,
            on_error=on_error or self.on_error,
            on_close=on_close or self.on_close
        )
        return ws
    
    # new connections could be created in response to on_XXX following same rules
    def create_connection(self, uri, on_open=None, on_message=None, on_error=None, on_close=None):
        print(&#39;create_connection&#39;)
        # ws = websocket.WebSocketApp(uri,
        #     on_open=on_open or self.on_open,
        #     on_message=on_message or self.on_message,
        #     on_error=on_error or self.on_error,
        #     on_close=on_close or self.on_close
        # )
        ws = self.create_websocket(uri, on_open, on_message, on_error, on_close)
        # ws.run_forever(reconnect=5)
        ws.run_forever(skip_utf8_validation=True, dispatcher=rel, reconnect=5)
        # print(&#39;before yield ws run_forever&#39;)
        # yield ws
        # print(&#39;start run_forever&#39;)
        # keep_on = True # use the return of run_forever to capture KeyboardInterrupt
        # while keep_on:
        #     try:
        #         keep_on = ws.run_forever(skip_utf8_validation=True, ping_interval=10, ping_timeout=8)
        #     except Exception as e:
        #         gc.collect()
        #         print(&#34;Websocket connection Error : {e}&#34;)                    
        #     print(&#34;Reconnecting websocket after 5 sec&#34;)
        #     time.sleep(5)
        return ws

    def on_message(self, ws, message):
        import datetime
        ct = datetime.datetime.now()
        print(&#34;on_message on_message on_message&#34;, ct)
        self._safe_handle(ws, message)

    def on_error(self, ws, error):
        print(f&#39;Male.on_error: {error}&#39;)

    def on_close(self, ws, close_status_code, close_msg):
        print(f&#34;Male.on_close: {ws} closed with status code {close_status_code} and message {close_msg}&#34;)
        # print (&#34;Retry connection: %s&#34; % time.ctime())
        # time.sleep(5)
        # self.run() # retry per 5 seconds
    
    # override this function to do something when connection is established
    def on_open(self, ws):
        pass

    @staticmethod
    def _make_data_dict(code, **extra_args):
        return {
            &#39;code&#39;: code,
            &#39;extra&#39;: extra_args
        }

    def _send_data_to_ws(self, ws, code, **extra_args):
        data_dict = self._make_data_dict(code=code, **extra_args)
        self._safe_send(ws, data_dict)

    def _safe_send(self, ws, data):
        try:
            if isinstance(data, dict):
                data = json.dumps(data)
            else:
                pass
            import datetime;
            ct = datetime.datetime.now()
            print(&#34;active send&#34;, ct)
            ws.send(data)
            return True

        except websocket.WebSocketConnectionClosedException as e:
            print(&#39;Male: _safe_send: Connection Closed Exception.&#39;, e)
            
            return False
        except Exception as e:
            traceback.print_exc()
            print(&#39;Male: self._safe_send: Exception Occurs&#39;, e)
            
            return False

    def echo(self, ws, message):
        print(f&#39;echo() received message: {message}&#39;)
        message = &#34;I got your message: {}&#34;.format(message)
        self._safe_send(ws, message)

    def _safe_handle(self, ws, message):
        
        import datetime;

        # # ct stores current time
        
        try:
            ct = datetime.datetime.now()
            print(&#34;before social active _safe_handle current time:-&#34;, ct)
            data = json.loads(message)
            # ct = datetime.datetime.now()
            # print(&#39;data&#39;, data, ct)
            self._handle_data_dict(data, ws)

        except ValueError as e:
            # traceback.print_exc()
            print(f&#39;Male: _safe_handle received non-json message {message}&#39;)
        
        except Exception as e:
            print(&#39;Male: Server function error!&#39;)
            traceback.print_exc()
        
        # import datetime;

        # # ct stores current time
        # ct = datetime.datetime.now()
        # print(&#34;after social active _safe_handle current time:-&#34;, ct)

    # override this function to handle data
    def _handle_data_dict(self, data, ws):
        print(f&#39;Male default: _handle_data_dict received {data} at websocket {ws}&#39;)
        

    def run(self):
        uri = &#39;wss://frog.4fun.chat/social&#39;
        self.create_connection(uri)
        # print(&#34;after create_connection&#34;)
        rel.signal(2, rel.abort)  # Keyboard Interrupt, one for all connections
        # print(&#34;after signal&#34;)
        rel.dispatch()
        # print(&#34;after everything in run&#34;)
    
    # def run(self):
    #     uri = &#39;wss://frog.4fun.chat/social&#39;
    #     ws = self.create_connection(uri)
    #     # _thread.start_new_thread(self.create_connection, (uri,))
    #     # # ws = websocket.WebSocketApp(&#34;ws://127.0.0.1:3000&#34;, on_open = on_open, on_close = on_close)
    #     # wst = threading.Thread(target=ws.run_forever())
    #     # wst.daemon = True
    #     # print(&#39;before start&#39;)
    #     # wst.start()
    #     # print(&#39;after start&#39;)</code></pre>
</details>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="socialization.ccs.base_god_service.BaseGodService" href="base_god_service.html#socialization.ccs.base_god_service.BaseGodService">BaseGodService</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="socialization.ccs.JSONWebsocketActiveService.create_connection"><code class="name flex">
<span>def <span class="ident">create_connection</span></span>(<span>self, uri, on_open=None, on_message=None, on_error=None, on_close=None)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_connection(self, uri, on_open=None, on_message=None, on_error=None, on_close=None):
    print(&#39;create_connection&#39;)
    # ws = websocket.WebSocketApp(uri,
    #     on_open=on_open or self.on_open,
    #     on_message=on_message or self.on_message,
    #     on_error=on_error or self.on_error,
    #     on_close=on_close or self.on_close
    # )
    ws = self.create_websocket(uri, on_open, on_message, on_error, on_close)
    # ws.run_forever(reconnect=5)
    ws.run_forever(skip_utf8_validation=True, dispatcher=rel, reconnect=5)
    # print(&#39;before yield ws run_forever&#39;)
    # yield ws
    # print(&#39;start run_forever&#39;)
    # keep_on = True # use the return of run_forever to capture KeyboardInterrupt
    # while keep_on:
    #     try:
    #         keep_on = ws.run_forever(skip_utf8_validation=True, ping_interval=10, ping_timeout=8)
    #     except Exception as e:
    #         gc.collect()
    #         print(&#34;Websocket connection Error : {e}&#34;)                    
    #     print(&#34;Reconnecting websocket after 5 sec&#34;)
    #     time.sleep(5)
    return ws</code></pre>
</details>
</dd>
<dt id="socialization.ccs.JSONWebsocketActiveService.create_websocket"><code class="name flex">
<span>def <span class="ident">create_websocket</span></span>(<span>self, uri, on_open=None, on_message=None, on_error=None, on_close=None)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create_websocket(self, uri, on_open=None, on_message=None, on_error=None, on_close=None):
    print(&#39;create_websocket&#39;)
    ws = websocket.WebSocketApp(uri,
        on_open=on_open or self.on_open,
        on_message=on_message or self.on_message,
        on_error=on_error or self.on_error,
        on_close=on_close or self.on_close
    )
    return ws</code></pre>
</details>
</dd>
<dt id="socialization.ccs.JSONWebsocketActiveService.echo"><code class="name flex">
<span>def <span class="ident">echo</span></span>(<span>self, ws, message)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def echo(self, ws, message):
    print(f&#39;echo() received message: {message}&#39;)
    message = &#34;I got your message: {}&#34;.format(message)
    self._safe_send(ws, message)</code></pre>
</details>
</dd>
<dt id="socialization.ccs.JSONWebsocketActiveService.on_close"><code class="name flex">
<span>def <span class="ident">on_close</span></span>(<span>self, ws, close_status_code, close_msg)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def on_close(self, ws, close_status_code, close_msg):
    print(f&#34;Male.on_close: {ws} closed with status code {close_status_code} and message {close_msg}&#34;)
    # print (&#34;Retry connection: %s&#34; % time.ctime())
    # time.sleep(5)
    # self.run() # retry per 5 seconds</code></pre>
</details>
</dd>
<dt id="socialization.ccs.JSONWebsocketActiveService.on_error"><code class="name flex">
<span>def <span class="ident">on_error</span></span>(<span>self, ws, error)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def on_error(self, ws, error):
    print(f&#39;Male.on_error: {error}&#39;)</code></pre>
</details>
</dd>
<dt id="socialization.ccs.JSONWebsocketActiveService.on_message"><code class="name flex">
<span>def <span class="ident">on_message</span></span>(<span>self, ws, message)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def on_message(self, ws, message):
    import datetime
    ct = datetime.datetime.now()
    print(&#34;on_message on_message on_message&#34;, ct)
    self._safe_handle(ws, message)</code></pre>
</details>
</dd>
<dt id="socialization.ccs.JSONWebsocketActiveService.on_open"><code class="name flex">
<span>def <span class="ident">on_open</span></span>(<span>self, ws)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def on_open(self, ws):
    pass</code></pre>
</details>
</dd>
<dt id="socialization.ccs.JSONWebsocketActiveService.run"><code class="name flex">
<span>def <span class="ident">run</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def run(self):
    uri = &#39;wss://frog.4fun.chat/social&#39;
    self.create_connection(uri)
    # print(&#34;after create_connection&#34;)
    rel.signal(2, rel.abort)  # Keyboard Interrupt, one for all connections
    # print(&#34;after signal&#34;)
    rel.dispatch()
    # print(&#34;after everything in run&#34;)</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="socialization.ccs.JSONWebsocketPassiveService"><code class="flex name class">
<span>class <span class="ident">JSONWebsocketPassiveService</span></span>
<span>(</span><span>port=7654)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class JSONWebsocketPassiveService:
    def __init__(self, port=7654):
        self.port = port

    @property
    def _timestamp(self):
        now = datetime.now(timezone.utc)
        epoch = datetime(1970, 1, 1, tzinfo=timezone.utc) # use POSIX epoch
        return (now - epoch) // timedelta(microseconds=1) # or `/ 1e3` for float

    @staticmethod
    def _make_data_dict(code, **extra_args):
        return {
            &#39;code&#39;: code,
            &#39;extra&#39;: extra_args
        }

    async def _safe_send(self, ws, data):
        # import datetime;

        # ct stores current time
        # ct = datetime.datetime.now()
        # print(&#34;before social passive _safe_sendcurrent time:-&#34;, ct, data)
        
        try:
            if isinstance(data, dict):
                data = json.dumps(data)
            else:
                pass
            
            await ws.send(data)
            # ct stores current time
            # ct = datetime.datetime.now()
            # print(&#34;after social passive _safe_sendcurrent time:-&#34;, ct)
            return True
        except websockets.ConnectionClosedOK as e:
            print(&#39;_safe_send: Connection Closed OK Exception.&#39;, e)
            
            return False
        except websockets.ConnectionClosed as e:
            print(&#39;_safe_send: Connection Closed Exception.&#39;, e)
            
            return False
        except Exception as e:
            traceback.print_exc()
            print(&#39;self._safe_send: Exception Occurs&#39;, e)
            
            return False
        
        
    async def _send_data_to_ws(self, ws, code, **extra_args):
        data_dict = self._make_data_dict(code=code, **extra_args)
        await self._safe_send(ws, data_dict)

    async def echo(self, ws, message):
        print(f&#39;echo() received message: {message}&#39;)
        message = &#34;I got your message: {}&#34;.format(message)
        await self._safe_send(ws, message)

    async def _safe_handle(self, ws, path):
        # import datetime;

        # ct stores current time
        # ct = datetime.datetime.now()
        # print(&#34;before social passive _safe_handle current time:-&#34;, ct)
        try:    # This websocket may be closed
            async for message in ws:
                try:
                    import datetime
                    ct = datetime.datetime.now()
                    print(&#34;passive handle&#34;, ct, message)
                    data = json.loads(message)
                    await self._handle_data_dict(data, ws, path)

                
                except Exception as e:
                    traceback.print_exc()
                    await self._handle_internal_error(e, ws, path)
            # ct = datetime.datetime.now()
            # print(&#34;after social passive _safe_handle current time:-&#34;, ct)
        except Exception as e:
            print(&#39;Exception in handle(): &#39;, e)

    async def _handle_data_dict(self, data, ws, path):
        await self._safe_send(ws, &#39;Female: _handle_data_dict Not Implemented&#39;)

    async def _handle_internal_error(self, e, ws, path):
        await self._safe_send(ws, f&#39;Female._handle_internal_error: {e}&#39;)

    # call this for the coroutine to start
    def get_server_coroutine(self):
        return websockets.serve(self._safe_handle, &#39;localhost&#39;, self.port)</code></pre>
</details>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="socialization.ccs.base_goddess_service.BaseGoddessService" href="base_goddess_service.html#socialization.ccs.base_goddess_service.BaseGoddessService">BaseGoddessService</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="socialization.ccs.JSONWebsocketPassiveService.echo"><code class="name flex">
<span>async def <span class="ident">echo</span></span>(<span>self, ws, message)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def echo(self, ws, message):
    print(f&#39;echo() received message: {message}&#39;)
    message = &#34;I got your message: {}&#34;.format(message)
    await self._safe_send(ws, message)</code></pre>
</details>
</dd>
<dt id="socialization.ccs.JSONWebsocketPassiveService.get_server_coroutine"><code class="name flex">
<span>def <span class="ident">get_server_coroutine</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_server_coroutine(self):
    return websockets.serve(self._safe_handle, &#39;localhost&#39;, self.port)</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="socialization.ccs.WrappedGodService"><code class="flex name class">
<span>class <span class="ident">WrappedGodService</span></span>
<span>(</span><span>name='WrappedGodService')</span>
</code></dt>
<dd>
<div class="desc"><p>This is the wrapped God service.
CCS provides a various of features for users in corresponding channels to use.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class WrappedGodService(BaseGodService):
    &#34;&#34;&#34;
        This is the wrapped God service.
        CCS provides a various of features for users in corresponding channels to use.
    &#34;&#34;&#34;

    def __init__(self, name=&#39;WrappedGodService&#39;):
        super().__init__()
        self.agent = WrappedGoddessDBAgent(name+&#34;.json&#34;)
        self.uri = None
        self.name = &#39;WrappedGodService&#39;
        self.feature_commands = []

        self.basic_command_func_map = {}
        self.notice_func_map = {}
        self.feature_func_map = {}

        self.prompt = {}

        self.message_func_map = {}
        
        self.temp_msg_map = {}

    def on_open(self, ws):
        &#34;&#34;&#34;
            Default behavior &#34;on_open&#34; for websocket.
            You can override this method to customize your own behavior.
            Also applies to &#34;on_message&#34;, &#34;on_error&#34; and &#34;on_close&#34;.
        &#34;&#34;&#34;
        data = {&#39;code&#39;: self.codes.COPERATION_GOD_RECONNECT, &#39;extra&#39;: {
            &#39;user_id&#39;: self.user_id, &#39;password&#39;: self.password}}
        print(&#39;SocialGodService send query: run: &#39;, data)
        self._send_ccs_operation(data, ws, None)
        print(self.name, &#39;opened&#39;)

    def add_feature(self, name, code, prompts, func=None):
        &#34;&#34;&#34;
            Add a feature to the service.
            Every feature contains a name, a code and a prompt.
            The code is always a five-digited int, and the first number must be 9, like 90001.
            The prompt here will be replaced by &#34;params&#34; in the future.
            Now it&#39;s the string that shows to the user in the input bar.
            You do not need to specify a handler func to the feature, but it&#39;s recommended to do so.
            If one feature with no handler is triggered, an exception will be raised.
            You can use set_feature_handle to set a handler for a feature.
        &#34;&#34;&#34;
        self.feature_commands.append(
            {&#39;name&#39;: name, &#39;code&#39;: code, &#39;prompts&#39;: [prompts] if prompts else []})
        self.prompt[code] = prompts
        if func:
            self.feature_func_map[code] = func

    def remove_feature(self, code):
        &#34;&#34;&#34;
            Remove a feature from the service.
            The feature is specified by its code.
        &#34;&#34;&#34;
        self.feature_commands = list(
            filter(lambda x: x[&#39;code&#39;] != code, self.feature_commands))
        self.feature_func_map.pop(code, None)

    def set_basic_command_handle(self, code, func):
        &#34;&#34;&#34;
            Set a handler for a basic command.
            The command is specified by its code.
            Some commands will be like &#34;help&#34;, &#34;quit&#34;.
        &#34;&#34;&#34;
        self.basic_command_func_map[code] = func

    def set_notice_handle(self, code, func):
        &#34;&#34;&#34;
            Set a handler for a notice.
            The notice is specified by its code.
            Some notices will be like &#34;user joined the channel&#34;, &#34;user left the channel&#34;.
        &#34;&#34;&#34;
        self.notice_func_map[code] = func

    def set_feature_handle(self, code, func):
        &#34;&#34;&#34;
            Set a handler for a feature.
            The feature is specified by its code.
        &#34;&#34;&#34;
        self.feature_func_map[code] = func

    def set_message_handle(self, code, func):
        &#34;&#34;&#34;
            Set a handler for a message.
            This code is always MESSAGE_TO_CCS.
        &#34;&#34;&#34;
        self.message_func_map[code] = func

    def _handle_data_dict(self, data, ws):
        print(
            f&#39;WrappedGodService: _handle_data_dict received {data} at websocket {ws}&#39;)
        if data[&#39;code&#39;] == self.codes.MESSAGE_TO_CCS:
            try:
                self._handle_message_to_ccs(data, ws, self.path)
            except Exception as e:
                print(&#39;WrappedGodService: _handle_message_to_ccs error: &#39;, e)
        elif data[&#39;code&#39;] == self.codes.COMMAND_TO_CCS:
            try:
                self._handle_command_to_ccs(data, ws, self.path)
            except Exception as e:
                print(&#39;WrappedGodService: _handle_command_to_ccs error: &#39;, e)
        else:
            raise Exception(&#39;no handler for code&#39;, data[&#39;code&#39;])

    def _handle_message_to_ccs(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        if type_code in self.message_func_map:
            self.message_func_map[type_code](self, data, ws, path)
        else:
            raise Exception(&#39;no message function for code&#39;, type_code)

    def _handle_command_to_ccs(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        if 20000 &lt;= type_code &lt;= 29999:
            self._handle_basic_command(data, ws, path)
        elif 80000 &lt;= type_code &lt;= 89999:
            self._handle_notice(data, ws, path)
        elif 90000 &lt;= type_code &lt;= 99999:
            self._handle_feature(data, ws, path)
        else:
            raise Exception(&#39;no command function for code&#39;, type_code)

    def _handle_basic_command(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        if type_code in self.basic_command_func_map:
            self.basic_command_func_map[type_code](self, data, ws, path)
        else:
            raise Exception(&#39;no basic command function for code&#39;, type_code)

    def _handle_notice(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        if type_code in self.notice_func_map:
            self.notice_func_map[type_code](self, data, ws, path)
        else:
            raise Exception(&#39;no notice function for code&#39;, type_code)

    def _handle_feature(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        if type_code in self.feature_func_map:
            self.feature_func_map[type_code](self, data, ws, path)
        else:
            raise Exception(&#39;no feature function for code&#39;, type_code)

    def _send_ccs_operation(self, data, ws, path):
        print(&#39;WrappedGodService ccs_operation: &#39;, data)
        code = data[&#39;code&#39;]
        password = data[&#39;extra&#39;][&#39;password&#39;]
        user_id = data[&#39;extra&#39;][&#39;user_id&#39;]
        if code == self.codes.COPERATION_GOD_RECONNECT:
            self._send_data_to_ws(
                ws, self.codes.COPERATION_GOD_RECONNECT, user_id=user_id, password=password)
        else:
            raise Exception(&#39;no ccs operation for code&#39;, code)

    def _send_command_down(self, ws, type_code, **kwargs):
        self._send_data_to_ws(ws, self.codes.COMMAND_FROM_CCS,
                              type_code=type_code, **kwargs)

    def _send_message_down(self, ws, type_code, channel_id, to_user_ids, origin, **kwargs):
        self._send_data_to_ws(ws, self.codes.MESSAGE_FROM_CCS,
                              type_code=type_code, channel_id=channel_id, to_user_ids=to_user_ids,
                              origin=origin, **kwargs)

    def broadcast_command_text(self, data, ws, text, clear=False):
        &#34;&#34;&#34;
            Broadcast a text to all users in a channel.
        &#34;&#34;&#34;
        channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;]
        self._send_command_down(
            ws,
            self.codes.COMMAND_DOWN_DISPLAY_TEXT,
            channel_id=channel_id,
            to_user_ids=self.agent.get_channel_user_list(channel_id),
            args={&#39;text&#39;: text, &#39;clear&#39;: clear}
        )

    def broadcast_command_image(self, data, ws, url):
        &#34;&#34;&#34;
            Broadcast an image to all users in a channel.
        &#34;&#34;&#34;
        channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;]
        self._send_command_down(
            ws,
            self.codes.COMMAND_DOWN_DISPLAY_IMAGE,
            channel_id=channel_id,
            to_user_ids=self.agent.get_channel_user_list(channel_id),
            args={
                &#39;type&#39;: &#39;url&#39;,
                &#39;image&#39;: url
            }
        )

    def reply_command_text(self, data, ws, text, clear=False):
        &#34;&#34;&#34;
            Reply a text to a single user.
        &#34;&#34;&#34;
        self._send_command_down(
            ws,
            self.codes.COMMAND_DOWN_DISPLAY_TEXT,
            channel_id=data[&#39;extra&#39;][&#39;channel_id&#39;],
            to_user_ids=[data[&#39;extra&#39;][&#39;user_id&#39;]],
            args={&#39;text&#39;: text, &#39;clear&#39;: clear}
        )

    def reply_command_image(self, data, ws, url):
        &#34;&#34;&#34;
            Reply an image to a single user.
        &#34;&#34;&#34;
        self._send_command_down(
            ws,
            self.codes.COMMAND_DOWN_DISPLAY_IMAGE,
            channel_id=data[&#39;extra&#39;][&#39;channel_id&#39;],
            to_user_ids=[data[&#39;extra&#39;][&#39;user_id&#39;]],
            args={&#39;type&#39;: &#39;url&#39;,  &#39;image&#39;: url}
        )

    def whistle_sender_command_text(
        self, data, ws, *,
        text_to_sender, text_to_others,
        clear_sender=False, clear_others=False
    ):
        &#34;&#34;&#34;
            Dog whistle.
        &#34;&#34;&#34;
        channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;]
        # to sender
        self._send_command_down(
            ws,
            self.codes.COMMAND_DOWN_DISPLAY_TEXT,
            channel_id=channel_id,
            to_user_ids=[data[&#39;extra&#39;][&#39;user_id&#39;]],
            args={&#39;text&#39;: text_to_sender, &#39;clear&#39;: clear_sender}
        )
        # to others
        self._send_command_down(
            ws,
            self.codes.COMMAND_DOWN_DISPLAY_TEXT,
            channel_id=channel_id,
            to_user_ids=list(set(self.agent.get_channel_user_list(
                channel_id)) - {data[&#39;extra&#39;][&#39;user_id&#39;]}),
            args={&#39;text&#39;: text_to_others, &#39;clear&#39;: clear_others}
        )

    def set_account(self, user_id, password):
        &#34;&#34;&#34;
            Set the account for the service.
            Fetch these in CH0000.
        &#34;&#34;&#34;
        self.user_id = user_id
        self.password = password

    def run(self):
        &#34;&#34;&#34;
            Run the service.
        &#34;&#34;&#34;
        uri = &#39;wss://frog.4fun.chat/social&#39; if self.uri is None else self.uri
        ws = self.create_connection(
            uri, self.on_open, self.on_message, self.on_error, self.on_close)

        rel.signal(2, rel.abort)  # Keyboard Interrupt, one for all connections
        rel.dispatch()</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="socialization.ccs.base_god_service.BaseGodService" href="base_god_service.html#socialization.ccs.base_god_service.BaseGodService">BaseGodService</a></li>
<li><a title="socialization.ccs.json_ws_active_service.JSONWebsocketActiveService" href="json_ws_active_service.html#socialization.ccs.json_ws_active_service.JSONWebsocketActiveService">JSONWebsocketActiveService</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="socialization.ccs.WrappedGodService.add_feature"><code class="name flex">
<span>def <span class="ident">add_feature</span></span>(<span>self, name, code, prompts, func=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Add a feature to the service.
Every feature contains a name, a code and a prompt.
The code is always a five-digited int, and the first number must be 9, like 90001.
The prompt here will be replaced by "params" in the future.
Now it's the string that shows to the user in the input bar.
You do not need to specify a handler func to the feature, but it's recommended to do so.
If one feature with no handler is triggered, an exception will be raised.
You can use set_feature_handle to set a handler for a feature.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_feature(self, name, code, prompts, func=None):
    &#34;&#34;&#34;
        Add a feature to the service.
        Every feature contains a name, a code and a prompt.
        The code is always a five-digited int, and the first number must be 9, like 90001.
        The prompt here will be replaced by &#34;params&#34; in the future.
        Now it&#39;s the string that shows to the user in the input bar.
        You do not need to specify a handler func to the feature, but it&#39;s recommended to do so.
        If one feature with no handler is triggered, an exception will be raised.
        You can use set_feature_handle to set a handler for a feature.
    &#34;&#34;&#34;
    self.feature_commands.append(
        {&#39;name&#39;: name, &#39;code&#39;: code, &#39;prompts&#39;: [prompts] if prompts else []})
    self.prompt[code] = prompts
    if func:
        self.feature_func_map[code] = func</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.broadcast_command_image"><code class="name flex">
<span>def <span class="ident">broadcast_command_image</span></span>(<span>self, data, ws, url)</span>
</code></dt>
<dd>
<div class="desc"><p>Broadcast an image to all users in a channel.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def broadcast_command_image(self, data, ws, url):
    &#34;&#34;&#34;
        Broadcast an image to all users in a channel.
    &#34;&#34;&#34;
    channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;]
    self._send_command_down(
        ws,
        self.codes.COMMAND_DOWN_DISPLAY_IMAGE,
        channel_id=channel_id,
        to_user_ids=self.agent.get_channel_user_list(channel_id),
        args={
            &#39;type&#39;: &#39;url&#39;,
            &#39;image&#39;: url
        }
    )</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.broadcast_command_text"><code class="name flex">
<span>def <span class="ident">broadcast_command_text</span></span>(<span>self, data, ws, text, clear=False)</span>
</code></dt>
<dd>
<div class="desc"><p>Broadcast a text to all users in a channel.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def broadcast_command_text(self, data, ws, text, clear=False):
    &#34;&#34;&#34;
        Broadcast a text to all users in a channel.
    &#34;&#34;&#34;
    channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;]
    self._send_command_down(
        ws,
        self.codes.COMMAND_DOWN_DISPLAY_TEXT,
        channel_id=channel_id,
        to_user_ids=self.agent.get_channel_user_list(channel_id),
        args={&#39;text&#39;: text, &#39;clear&#39;: clear}
    )</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.on_open"><code class="name flex">
<span>def <span class="ident">on_open</span></span>(<span>self, ws)</span>
</code></dt>
<dd>
<div class="desc"><p>Default behavior "on_open" for websocket.
You can override this method to customize your own behavior.
Also applies to "on_message", "on_error" and "on_close".</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def on_open(self, ws):
    &#34;&#34;&#34;
        Default behavior &#34;on_open&#34; for websocket.
        You can override this method to customize your own behavior.
        Also applies to &#34;on_message&#34;, &#34;on_error&#34; and &#34;on_close&#34;.
    &#34;&#34;&#34;
    data = {&#39;code&#39;: self.codes.COPERATION_GOD_RECONNECT, &#39;extra&#39;: {
        &#39;user_id&#39;: self.user_id, &#39;password&#39;: self.password}}
    print(&#39;SocialGodService send query: run: &#39;, data)
    self._send_ccs_operation(data, ws, None)
    print(self.name, &#39;opened&#39;)</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.remove_feature"><code class="name flex">
<span>def <span class="ident">remove_feature</span></span>(<span>self, code)</span>
</code></dt>
<dd>
<div class="desc"><p>Remove a feature from the service.
The feature is specified by its code.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def remove_feature(self, code):
    &#34;&#34;&#34;
        Remove a feature from the service.
        The feature is specified by its code.
    &#34;&#34;&#34;
    self.feature_commands = list(
        filter(lambda x: x[&#39;code&#39;] != code, self.feature_commands))
    self.feature_func_map.pop(code, None)</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.reply_command_image"><code class="name flex">
<span>def <span class="ident">reply_command_image</span></span>(<span>self, data, ws, url)</span>
</code></dt>
<dd>
<div class="desc"><p>Reply an image to a single user.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def reply_command_image(self, data, ws, url):
    &#34;&#34;&#34;
        Reply an image to a single user.
    &#34;&#34;&#34;
    self._send_command_down(
        ws,
        self.codes.COMMAND_DOWN_DISPLAY_IMAGE,
        channel_id=data[&#39;extra&#39;][&#39;channel_id&#39;],
        to_user_ids=[data[&#39;extra&#39;][&#39;user_id&#39;]],
        args={&#39;type&#39;: &#39;url&#39;,  &#39;image&#39;: url}
    )</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.reply_command_text"><code class="name flex">
<span>def <span class="ident">reply_command_text</span></span>(<span>self, data, ws, text, clear=False)</span>
</code></dt>
<dd>
<div class="desc"><p>Reply a text to a single user.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def reply_command_text(self, data, ws, text, clear=False):
    &#34;&#34;&#34;
        Reply a text to a single user.
    &#34;&#34;&#34;
    self._send_command_down(
        ws,
        self.codes.COMMAND_DOWN_DISPLAY_TEXT,
        channel_id=data[&#39;extra&#39;][&#39;channel_id&#39;],
        to_user_ids=[data[&#39;extra&#39;][&#39;user_id&#39;]],
        args={&#39;text&#39;: text, &#39;clear&#39;: clear}
    )</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.run"><code class="name flex">
<span>def <span class="ident">run</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Run the service.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def run(self):
    &#34;&#34;&#34;
        Run the service.
    &#34;&#34;&#34;
    uri = &#39;wss://frog.4fun.chat/social&#39; if self.uri is None else self.uri
    ws = self.create_connection(
        uri, self.on_open, self.on_message, self.on_error, self.on_close)

    rel.signal(2, rel.abort)  # Keyboard Interrupt, one for all connections
    rel.dispatch()</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.set_account"><code class="name flex">
<span>def <span class="ident">set_account</span></span>(<span>self, user_id, password)</span>
</code></dt>
<dd>
<div class="desc"><p>Set the account for the service.
Fetch these in CH0000.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_account(self, user_id, password):
    &#34;&#34;&#34;
        Set the account for the service.
        Fetch these in CH0000.
    &#34;&#34;&#34;
    self.user_id = user_id
    self.password = password</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.set_basic_command_handle"><code class="name flex">
<span>def <span class="ident">set_basic_command_handle</span></span>(<span>self, code, func)</span>
</code></dt>
<dd>
<div class="desc"><p>Set a handler for a basic command.
The command is specified by its code.
Some commands will be like "help", "quit".</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_basic_command_handle(self, code, func):
    &#34;&#34;&#34;
        Set a handler for a basic command.
        The command is specified by its code.
        Some commands will be like &#34;help&#34;, &#34;quit&#34;.
    &#34;&#34;&#34;
    self.basic_command_func_map[code] = func</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.set_feature_handle"><code class="name flex">
<span>def <span class="ident">set_feature_handle</span></span>(<span>self, code, func)</span>
</code></dt>
<dd>
<div class="desc"><p>Set a handler for a feature.
The feature is specified by its code.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_feature_handle(self, code, func):
    &#34;&#34;&#34;
        Set a handler for a feature.
        The feature is specified by its code.
    &#34;&#34;&#34;
    self.feature_func_map[code] = func</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.set_message_handle"><code class="name flex">
<span>def <span class="ident">set_message_handle</span></span>(<span>self, code, func)</span>
</code></dt>
<dd>
<div class="desc"><p>Set a handler for a message.
This code is always MESSAGE_TO_CCS.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_message_handle(self, code, func):
    &#34;&#34;&#34;
        Set a handler for a message.
        This code is always MESSAGE_TO_CCS.
    &#34;&#34;&#34;
    self.message_func_map[code] = func</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.set_notice_handle"><code class="name flex">
<span>def <span class="ident">set_notice_handle</span></span>(<span>self, code, func)</span>
</code></dt>
<dd>
<div class="desc"><p>Set a handler for a notice.
The notice is specified by its code.
Some notices will be like "user joined the channel", "user left the channel".</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_notice_handle(self, code, func):
    &#34;&#34;&#34;
        Set a handler for a notice.
        The notice is specified by its code.
        Some notices will be like &#34;user joined the channel&#34;, &#34;user left the channel&#34;.
    &#34;&#34;&#34;
    self.notice_func_map[code] = func</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGodService.whistle_sender_command_text"><code class="name flex">
<span>def <span class="ident">whistle_sender_command_text</span></span>(<span>self, data, ws, *, text_to_sender, text_to_others, clear_sender=False, clear_others=False)</span>
</code></dt>
<dd>
<div class="desc"><p>Dog whistle.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def whistle_sender_command_text(
    self, data, ws, *,
    text_to_sender, text_to_others,
    clear_sender=False, clear_others=False
):
    &#34;&#34;&#34;
        Dog whistle.
    &#34;&#34;&#34;
    channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;]
    # to sender
    self._send_command_down(
        ws,
        self.codes.COMMAND_DOWN_DISPLAY_TEXT,
        channel_id=channel_id,
        to_user_ids=[data[&#39;extra&#39;][&#39;user_id&#39;]],
        args={&#39;text&#39;: text_to_sender, &#39;clear&#39;: clear_sender}
    )
    # to others
    self._send_command_down(
        ws,
        self.codes.COMMAND_DOWN_DISPLAY_TEXT,
        channel_id=channel_id,
        to_user_ids=list(set(self.agent.get_channel_user_list(
            channel_id)) - {data[&#39;extra&#39;][&#39;user_id&#39;]}),
        args={&#39;text&#39;: text_to_others, &#39;clear&#39;: clear_others}
    )</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="socialization.ccs.WrappedGoddessDBAgent"><code class="flex name class">
<span>class <span class="ident">WrappedGoddessDBAgent</span></span>
<span>(</span><span>path)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class WrappedGoddessDBAgent:
    def __init__(self, path):
        self.path = path

        # create if not exist
        if not os.path.exists(self.path):
            with open(self.path, &#39;w&#39;) as f:
                json.dump({}, f)

    def leave_channel(self, channel_id, user_id):
        with open(self.path, &#39;r&#39;) as f:
            data = json.load(f)
        data[&#34;user_list&#34;][channel_id].remove(user_id)
        # write
        with open(self.path, &#39;w&#39;) as f:
            json.dump(data, f)

    def join_channel(self, channel_id, user_id):
        with open(self.path, &#39;r&#39;) as f:
            data = json.load(f)
        if not channel_id in data:
            data[&#34;user_list&#34;][channel_id] = []
        data[&#34;user_list&#34;][channel_id].append(user_id)
        # write
        with open(self.path, &#39;w&#39;) as f:
            json.dump(data, f)

    def get_channel_user_list(self, channel_id):
        with open(self.path, &#39;r&#39;) as f:
            data = json.load(f)
        if not (&#34;user_list&#34; in data and channel_id in data[&#34;user_list&#34;]):
            return []
        return data[&#34;user_list&#34;][channel_id]

    def init_user_id_list(self, channel_id, user_ids):
        with open(self.path, &#39;r&#39;) as f:
            data = json.load(f)
        data[&#34;user_list&#34;][channel_id] = user_ids or []
        with open(self.path, &#39;w&#39;) as f:
            json.dump(data, f)

    def init_dog_whistle(self, channel_id):
        with open(self.path, &#39;r&#39;) as f:
            data = json.load(f)
        data[&#34;dog_whistle&#34;][channel_id] = []
        with open(self.path, &#39;w&#39;) as f:
            json.dump(data, f)

    def add_whistle_msg(self, channel_id, msg, recipients):
        with open(self.path, &#39;r&#39;) as f:
            data = json.load(f)
        data[&#34;dog_whistle&#34;][channel_id].append({msg, recipients})
        with open(self.path, &#39;w&#39;) as f:
            json.dump(data, f)

    def get_whistle_recipients(self, channel_id, msg):
        with open(self.path, &#39;r&#39;) as f:
            data = json.load(f)
        if not (&#34;dog_whistle&#34; in data and channel_id in data[&#34;dog_whistle&#34;] and msg in data[&#34;dog_whistle&#34;][channel_id]):
            return []
        return data[&#34;dog_whistle&#34;][channel_id][msg]</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="socialization.ccs.WrappedGoddessDBAgent.add_whistle_msg"><code class="name flex">
<span>def <span class="ident">add_whistle_msg</span></span>(<span>self, channel_id, msg, recipients)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_whistle_msg(self, channel_id, msg, recipients):
    with open(self.path, &#39;r&#39;) as f:
        data = json.load(f)
    data[&#34;dog_whistle&#34;][channel_id].append({msg, recipients})
    with open(self.path, &#39;w&#39;) as f:
        json.dump(data, f)</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessDBAgent.get_channel_user_list"><code class="name flex">
<span>def <span class="ident">get_channel_user_list</span></span>(<span>self, channel_id)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_channel_user_list(self, channel_id):
    with open(self.path, &#39;r&#39;) as f:
        data = json.load(f)
    if not (&#34;user_list&#34; in data and channel_id in data[&#34;user_list&#34;]):
        return []
    return data[&#34;user_list&#34;][channel_id]</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessDBAgent.get_whistle_recipients"><code class="name flex">
<span>def <span class="ident">get_whistle_recipients</span></span>(<span>self, channel_id, msg)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_whistle_recipients(self, channel_id, msg):
    with open(self.path, &#39;r&#39;) as f:
        data = json.load(f)
    if not (&#34;dog_whistle&#34; in data and channel_id in data[&#34;dog_whistle&#34;] and msg in data[&#34;dog_whistle&#34;][channel_id]):
        return []
    return data[&#34;dog_whistle&#34;][channel_id][msg]</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessDBAgent.init_dog_whistle"><code class="name flex">
<span>def <span class="ident">init_dog_whistle</span></span>(<span>self, channel_id)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def init_dog_whistle(self, channel_id):
    with open(self.path, &#39;r&#39;) as f:
        data = json.load(f)
    data[&#34;dog_whistle&#34;][channel_id] = []
    with open(self.path, &#39;w&#39;) as f:
        json.dump(data, f)</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessDBAgent.init_user_id_list"><code class="name flex">
<span>def <span class="ident">init_user_id_list</span></span>(<span>self, channel_id, user_ids)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def init_user_id_list(self, channel_id, user_ids):
    with open(self.path, &#39;r&#39;) as f:
        data = json.load(f)
    data[&#34;user_list&#34;][channel_id] = user_ids or []
    with open(self.path, &#39;w&#39;) as f:
        json.dump(data, f)</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessDBAgent.join_channel"><code class="name flex">
<span>def <span class="ident">join_channel</span></span>(<span>self, channel_id, user_id)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def join_channel(self, channel_id, user_id):
    with open(self.path, &#39;r&#39;) as f:
        data = json.load(f)
    if not channel_id in data:
        data[&#34;user_list&#34;][channel_id] = []
    data[&#34;user_list&#34;][channel_id].append(user_id)
    # write
    with open(self.path, &#39;w&#39;) as f:
        json.dump(data, f)</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessDBAgent.leave_channel"><code class="name flex">
<span>def <span class="ident">leave_channel</span></span>(<span>self, channel_id, user_id)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def leave_channel(self, channel_id, user_id):
    with open(self.path, &#39;r&#39;) as f:
        data = json.load(f)
    data[&#34;user_list&#34;][channel_id].remove(user_id)
    # write
    with open(self.path, &#39;w&#39;) as f:
        json.dump(data, f)</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="socialization.ccs.WrappedGoddessService"><code class="flex name class">
<span>class <span class="ident">WrappedGoddessService</span></span>
<span>(</span><span>port, uri, token, name='WrappedGoddessService')</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class WrappedGoddessService(BaseGoddessService):
    def __init__(self, port, uri, token, name=&#39;WrappedGoddessService&#39;):
        super().__init__(port)
        self.agent = WrappedGoddessDBAgent(&#39;/home/ubuntu/social_backend/yellow502goddess.json&#39;)
        self.uri = uri
        self.token = token
        self.name = name
        
        self.feature_commands = []

        self.basic_command_func_map = {
            self.codes.COMMAND_UP_FETCH_CHANNEL_USER_LIST: handle_command_fetch_user_list,
            self.codes.COMMAND_UP_FETCH_RECIPIENT_LIST: handle_command_fetch_recipient_list,
            self.codes.COMMAND_UP_FETCH_CCS_COMMAND_LIST: handle_command_fetch_cmd_list,
        }
        
        self.notice_func_map = {
            self.codes.NOTICE_ASK_AUTH_TOKEN: handle_notice_auth_token,
            self.codes.NOTICE_TAKE_OVER: handle_notice_take_over,
            self.codes.NOTICE_RELEASE: handle_notice_release,
            self.codes.NOTICE_USER_JOINED: handle_notice_user_joined,
        }
        self.feature_func_map = {}

        self.prompt = {}

        self.message_func_map = {}


    def add_feature(self, name, code, prompts, func=None):
        self.feature_commands.append(
            {&#39;name&#39;: name, &#39;code&#39;: code, &#39;prompts&#39;: [prompts]})
        self.prompt[code] = prompts
        if func:
            self.feature_func_map[code] = func

    def set_basic_command_handle(self, code, func):
        self.basic_command_func_map[code] = func

    def set_notice_handle(self, code, func):
        self.notice_func_map[code] = func

    def set_feature_handle(self, code, func):
        self.feature_func_map[code] = func

    def set_message_handle(self, code, func):
        self.message_func_map[code] = func

    async def _handle_data_dict_core(self, data, ws, path):
        print(f&#39;WrappedGoddessService: _handle_data_dict received {data}.&#39;)
        if data[&#39;code&#39;] == self.codes.MESSAGE_TO_CCS:
            await self._handle_message_to_ccs(data, ws, path)
        elif data[&#39;code&#39;] == self.codes.COMMAND_TO_CCS:
            await self._handle_command_to_ccs(data, ws, path)
        else:
            pass
        
    async def _handle_data_dict(self, data, ws, path):
        asyncio.ensure_future(self._handle_data_dict_core(data, ws, path))

    async def _handle_message_to_ccs(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        if type_code in self.message_func_map:
            await self.message_func_map[type_code](self, data, ws, path)
        else:
            print(&#39;no message function for code&#39;, type_code)

    async def _handle_command_to_ccs(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        if 20000 &lt;= type_code &lt;= 29999:
            await self._handle_basic_command(data, ws, path)
        elif 80000 &lt;= type_code &lt;= 89999:
            await self._handle_notice(data, ws, path)
        elif 90000 &lt;= type_code &lt;= 99999:
            await self._handle_feature(data, ws, path)
        else:
            pass

    async def _handle_basic_command(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        if type_code in self.basic_command_func_map:
            await self.basic_command_func_map[type_code](self, data, ws, path)
        else:
            print(&#39;no basic_command function for code&#39;, type_code)
    


    async def _handle_notice(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        
        print(&#39;receive notice:&#39; + str(data))

        if type_code in self.notice_func_map:
            await self.notice_func_map[type_code](self, data, ws, path)
            
        else:
            if type_code == self.codes.NOTICE_USER_LEFT:
                channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;]
                # Here the CCS database may want to update to delete the new user
                # In the case of Social default Goddess, the database has been updated on OPERATION_JOIN
                user_id = data[&#39;extra&#39;][&#39;user_id&#39;]
                self.agent.leave_channel(channel_id, user_id)
                user_ids = self.agent.get_channel_user_list(channel_id)
                print(&#39;user_ids&#39;, user_ids)
                # serial_numbers= self.agent.user_id_list_to_serial_number_list(user_ids)
                # alias = [self.serial_number_to_alias(serial_number) for serial_number in serial_numbers]
                # print(&#39;alias&#39;, alias)
                # await self._send_command_down(ws, self.codes.COMMAND_DOWN_UPDATE_CHANNEL_USER_LIST,
                #     channel_id=channel_id, to_user_ids=user_ids)
                # await self._send_command_down(ws, self.codes.COMMAND_DOWN_UPDATE_CCS_COMMAND_LIST,
                #     channel_id=channel_id, to_user_ids=user_ids)
                
                await self._send_command_down(ws, self.codes.COMMAND_DOWN_UPDATE_CHANNEL_USER_LIST,
                    channel_id=channel_id, to_user_ids=user_ids, user_ids=user_ids)
                # await self._send_command_down(ws, self.codes.COMMAND_DOWN_UPDATE_CCS_COMMAND_LIST,
                #     channel_id=channel_id, to_user_ids=user_ids, commands=self.feature_commands)
                
            elif type_code == self.codes.NOTICE_GET_CHANNEL_USER_LIST:
                print(&#39;ccs yellowbear notice get channel user list&#39;, data)    
                

            else:
                raise Exception(&#39;yellowbear goddess Unknown type_code: {}&#39;.format(type_code))
        
        &#39;&#39;&#39;
        else:
            print(&#39;no notice function for code&#39;, type_code)
        &#39;&#39;&#39;

    async def _handle_feature(self, data, ws, path):
        type_code = data[&#39;extra&#39;][&#39;type_code&#39;]
        if type_code in self.feature_func_map:
            await self.feature_func_map[type_code](self, data, ws, path)
        else:
            print(&#39;no feature function for code&#39;, type_code)

    async def _send_ccs_operation(self, data, ws, path):
        print(&#39;WrappedGoddessService ccs_operation: &#39;, data)
        code = data[&#39;code&#39;]
        password = data[&#39;extra&#39;][&#39;password&#39;]
        ccs_id = data[&#39;extra&#39;][&#39;ccs_id&#39;]
        if code == self.codes.OPERATION_CCS_LOGIN:
            await self._send_data_to_ws(
                ws, self.codes.OPERATION_CCS_LOGIN, ccs_id=ccs_id, password=password)
        else:
            pass

    async def _send_command_down(self, ws, type_code, **kwargs):
        await self._send_data_to_ws(ws, self.codes.COMMAND_FROM_CCS,
                              type_code=type_code, **kwargs)
    
    ### Some wrapped functions, use them to make your work easier!
    
    # broadcast to all users
    async def broadcast_command_text(self, channel_id, ws, text, clear=False):
        await self._send_command_down(
            ws, 
            self.codes.COMMAND_DOWN_DISPLAY_TEXT,
            channel_id=channel_id, 
            to_user_ids=self.agent.get_channel_user_list(channel_id), 
            args={&#39;text&#39;: text, &#39;clear&#39;: clear}
        )
    
    async def broadcast_command_image(self, channel_id, ws, url, clear=False):
        await self._send_command_down(
            ws, 
            self.codes.COMMAND_DOWN_DISPLAY_IMAGE,
            channel_id=channel_id, 
            to_user_ids=self.agent.get_channel_user_list(channel_id), 
            args={&#39;type&#39;:&#39;url&#39;, &#39;image&#39;: url}
        )
    
    # only reply to the sender
    async def reply_command_text(self, data, ws, text, clear=False):
        await self._send_command_down(
            ws, 
            self.codes.COMMAND_DOWN_DISPLAY_TEXT,
            channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;], 
            to_user_ids = [data[&#39;extra&#39;][&#39;user_id&#39;]], 
            args = {&#39;text&#39;: text, &#39;clear&#39;: clear}
        )
    
    # two texts, one for sender, one for others
    async def whistle_sender_command_text(
        self, data, ws, *,
        text_to_sender, text_to_others, 
        clear_sender=False, clear_others=False
    ):
        # to sender
        await self._send_command_down(
            ws, 
            self.codes.COMMAND_DOWN_DISPLAY_TEXT,
            channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;], 
            to_user_ids = [data[&#39;extra&#39;][&#39;user_id&#39;]], 
            args = {&#39;text&#39;: text_to_sender, &#39;clear&#39;: clear_sender}
        )
        # to others
        user_ids = self.agent.get_channel_user_list(data[&#39;extra&#39;][&#39;channel_id&#39;])
        await self._send_command_down(
            ws, 
            self.codes.COMMAND_DOWN_DISPLAY_TEXT,
            channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;], 
            to_user_ids = list(set(user_ids) - {data[&#39;extra&#39;][&#39;user_id&#39;]}), 
            args = {&#39;text&#39;: text_to_others, &#39;clear&#39;: clear_others}
        )</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="socialization.ccs.base_goddess_service.BaseGoddessService" href="base_goddess_service.html#socialization.ccs.base_goddess_service.BaseGoddessService">BaseGoddessService</a></li>
<li><a title="socialization.ccs.json_ws_passive_service.JSONWebsocketPassiveService" href="json_ws_passive_service.html#socialization.ccs.json_ws_passive_service.JSONWebsocketPassiveService">JSONWebsocketPassiveService</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="socialization.ccs.WrappedGoddessService.add_feature"><code class="name flex">
<span>def <span class="ident">add_feature</span></span>(<span>self, name, code, prompts, func=None)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_feature(self, name, code, prompts, func=None):
    self.feature_commands.append(
        {&#39;name&#39;: name, &#39;code&#39;: code, &#39;prompts&#39;: [prompts]})
    self.prompt[code] = prompts
    if func:
        self.feature_func_map[code] = func</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessService.broadcast_command_image"><code class="name flex">
<span>async def <span class="ident">broadcast_command_image</span></span>(<span>self, channel_id, ws, url, clear=False)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def broadcast_command_image(self, channel_id, ws, url, clear=False):
    await self._send_command_down(
        ws, 
        self.codes.COMMAND_DOWN_DISPLAY_IMAGE,
        channel_id=channel_id, 
        to_user_ids=self.agent.get_channel_user_list(channel_id), 
        args={&#39;type&#39;:&#39;url&#39;, &#39;image&#39;: url}
    )</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessService.broadcast_command_text"><code class="name flex">
<span>async def <span class="ident">broadcast_command_text</span></span>(<span>self, channel_id, ws, text, clear=False)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def broadcast_command_text(self, channel_id, ws, text, clear=False):
    await self._send_command_down(
        ws, 
        self.codes.COMMAND_DOWN_DISPLAY_TEXT,
        channel_id=channel_id, 
        to_user_ids=self.agent.get_channel_user_list(channel_id), 
        args={&#39;text&#39;: text, &#39;clear&#39;: clear}
    )</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessService.reply_command_text"><code class="name flex">
<span>async def <span class="ident">reply_command_text</span></span>(<span>self, data, ws, text, clear=False)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def reply_command_text(self, data, ws, text, clear=False):
    await self._send_command_down(
        ws, 
        self.codes.COMMAND_DOWN_DISPLAY_TEXT,
        channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;], 
        to_user_ids = [data[&#39;extra&#39;][&#39;user_id&#39;]], 
        args = {&#39;text&#39;: text, &#39;clear&#39;: clear}
    )</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessService.set_basic_command_handle"><code class="name flex">
<span>def <span class="ident">set_basic_command_handle</span></span>(<span>self, code, func)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_basic_command_handle(self, code, func):
    self.basic_command_func_map[code] = func</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessService.set_feature_handle"><code class="name flex">
<span>def <span class="ident">set_feature_handle</span></span>(<span>self, code, func)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_feature_handle(self, code, func):
    self.feature_func_map[code] = func</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessService.set_message_handle"><code class="name flex">
<span>def <span class="ident">set_message_handle</span></span>(<span>self, code, func)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_message_handle(self, code, func):
    self.message_func_map[code] = func</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessService.set_notice_handle"><code class="name flex">
<span>def <span class="ident">set_notice_handle</span></span>(<span>self, code, func)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def set_notice_handle(self, code, func):
    self.notice_func_map[code] = func</code></pre>
</details>
</dd>
<dt id="socialization.ccs.WrappedGoddessService.whistle_sender_command_text"><code class="name flex">
<span>async def <span class="ident">whistle_sender_command_text</span></span>(<span>self, data, ws, *, text_to_sender, text_to_others, clear_sender=False, clear_others=False)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">async def whistle_sender_command_text(
    self, data, ws, *,
    text_to_sender, text_to_others, 
    clear_sender=False, clear_others=False
):
    # to sender
    await self._send_command_down(
        ws, 
        self.codes.COMMAND_DOWN_DISPLAY_TEXT,
        channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;], 
        to_user_ids = [data[&#39;extra&#39;][&#39;user_id&#39;]], 
        args = {&#39;text&#39;: text_to_sender, &#39;clear&#39;: clear_sender}
    )
    # to others
    user_ids = self.agent.get_channel_user_list(data[&#39;extra&#39;][&#39;channel_id&#39;])
    await self._send_command_down(
        ws, 
        self.codes.COMMAND_DOWN_DISPLAY_TEXT,
        channel_id = data[&#39;extra&#39;][&#39;channel_id&#39;], 
        to_user_ids = list(set(user_ids) - {data[&#39;extra&#39;][&#39;user_id&#39;]}), 
        args = {&#39;text&#39;: text_to_others, &#39;clear&#39;: clear_others}
    )</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="socialization" href="../index.html">socialization</a></code></li>
</ul>
</li>
<li><h3><a href="#header-submodules">Sub-modules</a></h3>
<ul>
<li><code><a title="socialization.ccs.base_god_service" href="base_god_service.html">socialization.ccs.base_god_service</a></code></li>
<li><code><a title="socialization.ccs.base_goddess_service" href="base_goddess_service.html">socialization.ccs.base_goddess_service</a></code></li>
<li><code><a title="socialization.ccs.json_ws_active_service" href="json_ws_active_service.html">socialization.ccs.json_ws_active_service</a></code></li>
<li><code><a title="socialization.ccs.json_ws_passive_service" href="json_ws_passive_service.html">socialization.ccs.json_ws_passive_service</a></code></li>
<li><code><a title="socialization.ccs.wrapped_god_service" href="wrapped_god_service.html">socialization.ccs.wrapped_god_service</a></code></li>
<li><code><a title="socialization.ccs.wrapped_goddess_db_agent" href="wrapped_goddess_db_agent.html">socialization.ccs.wrapped_goddess_db_agent</a></code></li>
<li><code><a title="socialization.ccs.wrapped_goddess_service" href="wrapped_goddess_service.html">socialization.ccs.wrapped_goddess_service</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="socialization.ccs.BaseGodService" href="#socialization.ccs.BaseGodService">BaseGodService</a></code></h4>
<ul class="">
<li><code><a title="socialization.ccs.BaseGodService.on_open" href="#socialization.ccs.BaseGodService.on_open">on_open</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="socialization.ccs.BaseGoddessService" href="#socialization.ccs.BaseGoddessService">BaseGoddessService</a></code></h4>
</li>
<li>
<h4><code><a title="socialization.ccs.JSONWebsocketActiveService" href="#socialization.ccs.JSONWebsocketActiveService">JSONWebsocketActiveService</a></code></h4>
<ul class="two-column">
<li><code><a title="socialization.ccs.JSONWebsocketActiveService.create_connection" href="#socialization.ccs.JSONWebsocketActiveService.create_connection">create_connection</a></code></li>
<li><code><a title="socialization.ccs.JSONWebsocketActiveService.create_websocket" href="#socialization.ccs.JSONWebsocketActiveService.create_websocket">create_websocket</a></code></li>
<li><code><a title="socialization.ccs.JSONWebsocketActiveService.echo" href="#socialization.ccs.JSONWebsocketActiveService.echo">echo</a></code></li>
<li><code><a title="socialization.ccs.JSONWebsocketActiveService.on_close" href="#socialization.ccs.JSONWebsocketActiveService.on_close">on_close</a></code></li>
<li><code><a title="socialization.ccs.JSONWebsocketActiveService.on_error" href="#socialization.ccs.JSONWebsocketActiveService.on_error">on_error</a></code></li>
<li><code><a title="socialization.ccs.JSONWebsocketActiveService.on_message" href="#socialization.ccs.JSONWebsocketActiveService.on_message">on_message</a></code></li>
<li><code><a title="socialization.ccs.JSONWebsocketActiveService.on_open" href="#socialization.ccs.JSONWebsocketActiveService.on_open">on_open</a></code></li>
<li><code><a title="socialization.ccs.JSONWebsocketActiveService.run" href="#socialization.ccs.JSONWebsocketActiveService.run">run</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="socialization.ccs.JSONWebsocketPassiveService" href="#socialization.ccs.JSONWebsocketPassiveService">JSONWebsocketPassiveService</a></code></h4>
<ul class="">
<li><code><a title="socialization.ccs.JSONWebsocketPassiveService.echo" href="#socialization.ccs.JSONWebsocketPassiveService.echo">echo</a></code></li>
<li><code><a title="socialization.ccs.JSONWebsocketPassiveService.get_server_coroutine" href="#socialization.ccs.JSONWebsocketPassiveService.get_server_coroutine">get_server_coroutine</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="socialization.ccs.WrappedGodService" href="#socialization.ccs.WrappedGodService">WrappedGodService</a></code></h4>
<ul class="">
<li><code><a title="socialization.ccs.WrappedGodService.add_feature" href="#socialization.ccs.WrappedGodService.add_feature">add_feature</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.broadcast_command_image" href="#socialization.ccs.WrappedGodService.broadcast_command_image">broadcast_command_image</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.broadcast_command_text" href="#socialization.ccs.WrappedGodService.broadcast_command_text">broadcast_command_text</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.on_open" href="#socialization.ccs.WrappedGodService.on_open">on_open</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.remove_feature" href="#socialization.ccs.WrappedGodService.remove_feature">remove_feature</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.reply_command_image" href="#socialization.ccs.WrappedGodService.reply_command_image">reply_command_image</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.reply_command_text" href="#socialization.ccs.WrappedGodService.reply_command_text">reply_command_text</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.run" href="#socialization.ccs.WrappedGodService.run">run</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.set_account" href="#socialization.ccs.WrappedGodService.set_account">set_account</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.set_basic_command_handle" href="#socialization.ccs.WrappedGodService.set_basic_command_handle">set_basic_command_handle</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.set_feature_handle" href="#socialization.ccs.WrappedGodService.set_feature_handle">set_feature_handle</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.set_message_handle" href="#socialization.ccs.WrappedGodService.set_message_handle">set_message_handle</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.set_notice_handle" href="#socialization.ccs.WrappedGodService.set_notice_handle">set_notice_handle</a></code></li>
<li><code><a title="socialization.ccs.WrappedGodService.whistle_sender_command_text" href="#socialization.ccs.WrappedGodService.whistle_sender_command_text">whistle_sender_command_text</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="socialization.ccs.WrappedGoddessDBAgent" href="#socialization.ccs.WrappedGoddessDBAgent">WrappedGoddessDBAgent</a></code></h4>
<ul class="">
<li><code><a title="socialization.ccs.WrappedGoddessDBAgent.add_whistle_msg" href="#socialization.ccs.WrappedGoddessDBAgent.add_whistle_msg">add_whistle_msg</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessDBAgent.get_channel_user_list" href="#socialization.ccs.WrappedGoddessDBAgent.get_channel_user_list">get_channel_user_list</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessDBAgent.get_whistle_recipients" href="#socialization.ccs.WrappedGoddessDBAgent.get_whistle_recipients">get_whistle_recipients</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessDBAgent.init_dog_whistle" href="#socialization.ccs.WrappedGoddessDBAgent.init_dog_whistle">init_dog_whistle</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessDBAgent.init_user_id_list" href="#socialization.ccs.WrappedGoddessDBAgent.init_user_id_list">init_user_id_list</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessDBAgent.join_channel" href="#socialization.ccs.WrappedGoddessDBAgent.join_channel">join_channel</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessDBAgent.leave_channel" href="#socialization.ccs.WrappedGoddessDBAgent.leave_channel">leave_channel</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="socialization.ccs.WrappedGoddessService" href="#socialization.ccs.WrappedGoddessService">WrappedGoddessService</a></code></h4>
<ul class="">
<li><code><a title="socialization.ccs.WrappedGoddessService.add_feature" href="#socialization.ccs.WrappedGoddessService.add_feature">add_feature</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessService.broadcast_command_image" href="#socialization.ccs.WrappedGoddessService.broadcast_command_image">broadcast_command_image</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessService.broadcast_command_text" href="#socialization.ccs.WrappedGoddessService.broadcast_command_text">broadcast_command_text</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessService.reply_command_text" href="#socialization.ccs.WrappedGoddessService.reply_command_text">reply_command_text</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessService.set_basic_command_handle" href="#socialization.ccs.WrappedGoddessService.set_basic_command_handle">set_basic_command_handle</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessService.set_feature_handle" href="#socialization.ccs.WrappedGoddessService.set_feature_handle">set_feature_handle</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessService.set_message_handle" href="#socialization.ccs.WrappedGoddessService.set_message_handle">set_message_handle</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessService.set_notice_handle" href="#socialization.ccs.WrappedGoddessService.set_notice_handle">set_notice_handle</a></code></li>
<li><code><a title="socialization.ccs.WrappedGoddessService.whistle_sender_command_text" href="#socialization.ccs.WrappedGoddessService.whistle_sender_command_text">whistle_sender_command_text</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>