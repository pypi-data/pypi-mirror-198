{"version":3,"file":"chunks/app_views_performance_transactionSummary_transactionReplays_index_tsx.xxxxxxxxxxxxxxxxxxxx.js","mappings":"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","sources":["webpack:///./app/views/performance/transactionSummary/transactionReplays/transactionReplays.tsx","webpack:///./app/views/performance/transactionSummary/transactionReplays/useReplaysFromTransaction.tsx","webpack:///./app/views/performance/transactionSummary/transactionReplays/useReplaysWithTxData.tsx","webpack:///./app/views/performance/transactionSummary/transactionReplays/index.tsx"],"sourcesContent":["import {Fragment, useEffect, useMemo} from 'react';\nimport {useTheme} from '@emotion/react';\nimport {Location} from 'history';\n\nimport * as Layout from 'sentry/components/layouts/thirds';\nimport LoadingIndicator from 'sentry/components/loadingIndicator';\nimport {t} from 'sentry/locale';\nimport type {Organization} from 'sentry/types';\nimport EventView from 'sentry/utils/discover/eventView';\nimport {\n  SPAN_OP_BREAKDOWN_FIELDS,\n  SPAN_OP_RELATIVE_BREAKDOWN_FIELD,\n} from 'sentry/utils/discover/fields';\nimport useReplayList from 'sentry/utils/replays/hooks/useReplayList';\nimport {useLocation} from 'sentry/utils/useLocation';\nimport useMedia from 'sentry/utils/useMedia';\nimport useOrganization from 'sentry/utils/useOrganization';\nimport useProjects from 'sentry/utils/useProjects';\nimport PageLayout, {\n  ChildProps,\n} from 'sentry/views/performance/transactionSummary/pageLayout';\nimport Tab from 'sentry/views/performance/transactionSummary/tabs';\nimport ReplayTable from 'sentry/views/replays/replayTable';\nimport {ReplayColumns} from 'sentry/views/replays/replayTable/types';\nimport type {ReplayListLocationQuery} from 'sentry/views/replays/types';\n\nimport useReplaysFromTransaction, {EventSpanData} from './useReplaysFromTransaction';\nimport useReplaysWithTxData from './useReplaysWithTxData';\n\nfunction TransactionReplays() {\n  const location = useLocation<ReplayListLocationQuery>();\n  const organization = useOrganization();\n  const {projects} = useProjects();\n\n  return (\n    <PageLayout\n      location={{\n        ...location,\n        query: {\n          ...location.query,\n          statsPeriod: '14d',\n        },\n      }}\n      organization={organization}\n      projects={projects}\n      tab={Tab.Replays}\n      getDocumentTitle={getDocumentTitle}\n      generateEventView={generateEventView}\n      childComponent={ReplaysContentWrapper}\n    />\n  );\n}\n\nfunction getDocumentTitle(transactionName: string): string {\n  const hasTransactionName =\n    typeof transactionName === 'string' && String(transactionName).trim().length > 0;\n\n  if (hasTransactionName) {\n    return [String(transactionName).trim(), t('Replays')].join(' \\u2014 ');\n  }\n\n  return [t('Summary'), t('Replays')].join(' \\u2014 ');\n}\n\nfunction generateEventView({\n  location,\n  transactionName,\n}: {\n  location: Location;\n  transactionName: string;\n}) {\n  const fields = [\n    'replayId',\n    'count()',\n    'transaction.duration',\n    'trace',\n    'timestamp',\n    ...SPAN_OP_BREAKDOWN_FIELDS,\n    SPAN_OP_RELATIVE_BREAKDOWN_FIELD,\n  ];\n\n  return EventView.fromSavedQuery({\n    id: '',\n    name: `Replay events within a transaction`,\n    version: 2,\n    fields,\n    query: `event.type:transaction transaction:\"${transactionName}\" !replayId:\"\"`,\n    projects: [Number(location.query.project)],\n  });\n}\n\nfunction ReplaysContentWrapper({\n  eventView: replayIdsEventView,\n  location,\n  organization,\n  setError,\n}: ChildProps) {\n  const {data, fetchError, isFetching, pageLinks} = useReplaysFromTransaction({\n    replayIdsEventView,\n    location,\n    organization,\n  });\n\n  useEffect(() => {\n    setError(fetchError?.message ?? fetchError);\n  }, [setError, fetchError]);\n\n  if (!data) {\n    return isFetching ? (\n      <Layout.Main fullWidth>\n        <LoadingIndicator />\n      </Layout.Main>\n    ) : (\n      <Fragment>{null}</Fragment>\n    );\n  }\n\n  const {events, replayRecordsEventView} = data;\n  return (\n    <ReplaysContent\n      eventView={replayRecordsEventView}\n      events={events}\n      organization={organization}\n      pageLinks={pageLinks}\n    />\n  );\n}\n\nfunction ReplaysContent({\n  eventView,\n  events,\n  organization,\n}: {\n  eventView: EventView;\n  events: EventSpanData[];\n  organization: Organization;\n  pageLinks: string | null;\n}) {\n  const location = useMemo(() => ({query: {}} as Location<ReplayListLocationQuery>), []);\n  const theme = useTheme();\n  const hasRoomForColumns = useMedia(`(min-width: ${theme.breakpoints.small})`);\n\n  const {replays, isFetching, fetchError} = useReplayList({\n    eventView,\n    location,\n    organization,\n  });\n\n  const replaysWithTx = useReplaysWithTxData({\n    replays,\n    events,\n  });\n\n  return (\n    <Layout.Main fullWidth>\n      <ReplayTable\n        fetchError={fetchError}\n        isFetching={isFetching}\n        replays={replaysWithTx}\n        sort={undefined}\n        visibleColumns={[\n          ReplayColumns.replay,\n          ...(hasRoomForColumns ? [ReplayColumns.slowestTransaction] : []),\n          ReplayColumns.os,\n          ReplayColumns.browser,\n          ReplayColumns.duration,\n          ReplayColumns.countErrors,\n          ReplayColumns.activity,\n        ]}\n      />\n    </Layout.Main>\n  );\n}\nexport default TransactionReplays;\n","import {useCallback, useEffect, useMemo, useState} from 'react';\nimport * as Sentry from '@sentry/react';\nimport {Location} from 'history';\n\nimport type {Organization} from 'sentry/types';\nimport EventView from 'sentry/utils/discover/eventView';\nimport {doDiscoverQuery} from 'sentry/utils/discover/genericDiscoverQuery';\nimport {decodeScalar} from 'sentry/utils/queryString';\nimport {DEFAULT_SORT} from 'sentry/utils/replays/fetchReplayList';\nimport useApi from 'sentry/utils/useApi';\nimport type {ReplayListLocationQuery} from 'sentry/views/replays/types';\nimport {REPLAY_LIST_FIELDS} from 'sentry/views/replays/types';\n\ntype Options = {\n  location: Location;\n  organization: Organization;\n  replayIdsEventView: EventView;\n};\n\nexport type EventSpanData = {\n  'count()': number;\n  replayId: string;\n  'span_ops_breakdown.relative': string;\n  'spans.browser': null | number;\n  'spans.db': null | number;\n  'spans.http': null | number;\n  'spans.resource': null | number;\n  'spans.ui': null | number;\n  timestamp: string;\n  trace: string;\n  'transaction.duration': number;\n};\n\ntype Return = {\n  data: null | {\n    events: EventSpanData[];\n    replayRecordsEventView: EventView;\n  };\n  fetchError: any;\n  isFetching: boolean;\n  pageLinks: null | string;\n};\n\nfunction useReplaysFromTransaction({\n  location,\n  organization,\n  replayIdsEventView,\n}: Options): Return {\n  const api = useApi();\n\n  const [response, setResponse] = useState<{\n    events: EventSpanData[];\n    pageLinks: null | string;\n    replayIds: undefined | string[];\n  }>({events: [], pageLinks: null, replayIds: undefined});\n\n  const [fetchError, setFetchError] = useState<any>();\n\n  const {cursor} = location.query;\n  const fetchReplayIds = useCallback(async () => {\n    try {\n      const [{data}, _textStatus, resp] = await doDiscoverQuery<{data: EventSpanData[]}>(\n        api,\n        `/organizations/${organization.slug}/events/`,\n        replayIdsEventView.getEventsAPIPayload({\n          query: {cursor},\n        } as Location<ReplayListLocationQuery>)\n      );\n\n      setResponse({\n        pageLinks: resp?.getResponseHeader('Link') ?? '',\n        replayIds: data.map(record => String(record.replayId)),\n        events: data || [],\n      });\n    } catch (err) {\n      Sentry.captureException(err);\n      setFetchError(err);\n    }\n  }, [api, cursor, organization.slug, replayIdsEventView]);\n\n  const replayRecordsEventView = useMemo(() => {\n    if (!response.replayIds) {\n      return null;\n    }\n    return EventView.fromSavedQuery({\n      id: '',\n      name: '',\n      version: 2,\n      fields: REPLAY_LIST_FIELDS,\n      projects: [],\n      query: `id:[${String(response.replayIds)}]`,\n      orderby: decodeScalar(location.query.sort, DEFAULT_SORT),\n    });\n  }, [location.query.sort, response.replayIds]);\n\n  useEffect(() => {\n    fetchReplayIds();\n  }, [fetchReplayIds]);\n\n  return {\n    data: replayRecordsEventView\n      ? {\n          events: response.events,\n          replayRecordsEventView,\n        }\n      : null,\n    fetchError,\n    isFetching: !fetchError && !response.replayIds,\n    pageLinks: response.pageLinks,\n  };\n}\n\nexport default useReplaysFromTransaction;\n","import {EventSpanData} from 'sentry/views/performance/transactionSummary/transactionReplays/useReplaysFromTransaction';\nimport {ReplayListRecord} from 'sentry/views/replays/types';\n\ntype Opts = {\n  events: EventSpanData[];\n  replays: undefined | ReplayListRecord[];\n};\n\nexport type ReplayListRecordWithTx = ReplayListRecord & {\n  txEvent: {[x: string]: any};\n};\n\ntype Return = undefined | ReplayListRecordWithTx[];\n\nfunction useReplaysWithTxData({events, replays}: Opts): Return {\n  const replaysWithTx = replays?.map<ReplayListRecordWithTx>(replay => {\n    const slowestEvent = events.reduce((slowest, event) => {\n      if (event.replayId !== replay.id) {\n        return slowest;\n      }\n      if (!slowest['transaction.duration']) {\n        return event;\n      }\n      return event['transaction.duration'] > slowest['transaction.duration']\n        ? event\n        : slowest;\n    }, {});\n\n    return {\n      ...replay,\n      txEvent: slowestEvent ?? {},\n    };\n  });\n\n  return replaysWithTx;\n}\n\nexport default useReplaysWithTxData;\n","import Feature from 'sentry/components/acl/feature';\nimport {Alert} from 'sentry/components/alert';\nimport * as Layout from 'sentry/components/layouts/thirds';\nimport {t} from 'sentry/locale';\nimport useOrganization from 'sentry/utils/useOrganization';\n\nimport TransactionReplays from './transactionReplays';\n\nfunction renderNoAccess() {\n  return (\n    <Layout.Page withPadding>\n      <Alert type=\"warning\">{t(\"You don't have access to this feature\")}</Alert>\n    </Layout.Page>\n  );\n}\n\nfunction TransactionReplaysContainer() {\n  const organization = useOrganization();\n\n  return (\n    <Feature\n      features={['session-replay']}\n      organization={organization}\n      renderDisabled={renderNoAccess}\n    >\n      <TransactionReplays />\n    </Feature>\n  );\n}\n\nexport default TransactionReplaysContainer;\n"],"names":["TransactionReplays","location","useLocation","organization","useOrganization","projects","useProjects","_jsx","PageLayout","query","statsPeriod","tab","Tab","getDocumentTitle","generateEventView","childComponent","ReplaysContentWrapper","transactionName","String","trim","length","t","join","_ref","fields","SPAN_OP_BREAKDOWN_FIELDS","SPAN_OP_RELATIVE_BREAKDOWN_FIELD","EventView","id","name","version","Number","project","_ref2","eventView","replayIdsEventView","setError","data","fetchError","isFetching","pageLinks","api","useApi","response","setResponse","useState","events","replayIds","undefined","setFetchError","cursor","fetchReplayIds","useCallback","async","_textStatus","resp","doDiscoverQuery","slug","getEventsAPIPayload","getResponseHeader","map","record","replayId","err","Sentry","replayRecordsEventView","useMemo","REPLAY_LIST_FIELDS","orderby","decodeScalar","sort","DEFAULT_SORT","useEffect","useReplaysFromTransaction","message","Layout","fullWidth","children","LoadingIndicator","Fragment","ReplaysContent","_ref3","theme","useTheme","hasRoomForColumns","useMedia","breakpoints","small","replays","useReplayList","replaysWithTx","replay","slowestEvent","reduce","slowest","event","txEvent","useReplaysWithTxData","ReplayTable","visibleColumns","ReplayColumns","displayName","renderNoAccess","withPadding","Alert","type","TransactionReplaysContainer","Feature","features","renderDisabled"],"sourceRoot":""}