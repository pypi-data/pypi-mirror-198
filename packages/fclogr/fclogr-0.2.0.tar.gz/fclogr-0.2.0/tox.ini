# Copyright (c) 2023 Maxwell G <gotmax@e.email>
# SPDX-License-Identifier: GPL-2.0-or-later

[tox]
env_list =
    format
    py{39,310,311}
    typing-py{39,310,311}
isolated_build = True

[testenv:py{39,310,311}]
labels =
    test
extras =
    test
commands =
    pytest

[testenv:typing-py{39,310,311}]
labels =
    lint
    typing
extras =
    lint
commands =
    mypy src/fclogr

[testenv:format]
extras =
    lint
labels =
    lint
ignore_errors = True
commands =
    black {posargs} src/fclogr/
    isort --add-import "from __future__ import annotations" {posargs} src/fclogr/
    reuse lint
    ruff src/fclogr/

[testenv:bump]
skip_install = True
allowlist_externals =
    git
    sed
commands =
    sed -i 's|^version.*$|version = "'"{posargs}"'"|' pyproject.toml
    git add pyproject.toml
    git commit -S -m "Release {posargs}"
    git tag -a "v{posargs}" -F NEWS.md

[testenv:publish]
skip_install = True
deps =
    dbus-python
    flit
    keyring
    twine
allowlist_externals = *
passenv = *
commands =
    - sh -c 'rm -rf dist/*'
    python -m flit build
    python -m twine check --strict dist/*
    sh -c 'bsdtar tf dist/*.whl | grep LICENSE'
    sh -c 'bsdtar tf dist/*.tar.gz | grep LICENSE'
    python -m twine upload -s -i maxwell@gtmx.me --non-interactive -u __token__ dist/*
    git push --follow-tags
    sh -c 'hut git artifact upload dist/*'
    sed -i 's|^\(version.*=.*\)"$|\1.post0"|' pyproject.toml
    git add pyproject.toml
    git commit -S -m "Post release version bump"
