[tox]
envlist= py38,py39,py39
isolated_build = True

[testenv]
setenv =
    devdeps: PIP_EXTRA_INDEX_URL = https://pypi.anaconda.org/scipy-wheels-nightly/simple
deps=
    devdeps: -rrequirements-dev.txt
    # Newer versions of gwcs require astropy 4.x, which
    # isn't compatible with the older versions of numpy
    # that we test with.
    legacy: gwcs==0.9.1
# NOTE: this dependency on `six` is only here because `gwcs <= 0.18.1` requires it
    legacy: six~=1.4.0
    legacy: semantic_version==2.8
    legacy: pyyaml==3.13
    legacy: jsonschema==4.0.1
    legacy: numpy~=1.18
    legacy: pytest~=6.0.0
    legacy: astropy~=5.0.4
    numpydev: cython
extras= all,tests
# astropy will complain if the home directory is missing
passenv= HOME
usedevelop= true
commands=
    pip freeze
    pytest --remote-data

# coverage run must be used because the pytest-asdf plugin will interfere
# with proper coverage measurement due to the order pytest loads its
# entry points.
[testenv:coverage]
deps=
    coverage
commands=
    pip freeze
    coverage run --source=asdf --rcfile={toxinidir}/pyproject.toml \
                     -m pytest --remote-data --open-files
    coverage xml -o {toxinidir}/coverage.xml

[testenv:compatibility]
deps=
    virtualenv
extras= all,tests
commands=
    pip freeze
    pytest compatibility_tests/ --remote-data
