# SPDX-FileCopyrightText: 2022 Maxwell G <gotmax@e.email>
# SPDX-License-Identifier: GPL-2.0-or-later

---
image: fedora/rawhide
packages:
  - hut
  - tar
  - python3-libdnf5
secrets:
  # Production Copr
  # - 759db354-8651-427c-b00a-0755164c8cae
  # Dev Copr
  - 9683b939-5f2b-4a0a-966e-acd99b5944a0
environment:
  nox: ./venv/bin/nox
oauth: pages.sr.ht/PAGES:RW
sources:
  - https://git.sr.ht/~gotmax23/fedrq
tasks:
  - copr-webhook: |
      cd fedrq/
      if ! [ -x "${HOME}/.copr-dev-hook" ]
      then
        echo "Not submitting copr build. Secrets are disbaled."
        exit
      fi
      if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/main)" ]
      then
        echo "Not submitting copr-build. Branch is not main."
        exit
      fi
      ~/.copr-dev-hook
  - submit-man: |
      sudo dnf copr enable -y gotmax23/scd2html
      sudo dnf install -y scd2html
      cd fedrq/doc
      scd2html < fedrq.1.scd > fedrq.1.html
      scd2html < fedrq.5.scd > fedrq.5.html
      sed -i 's|\(code{white-space: \)pre-wrap;}|\1pre;}|' fedrq.?.html
      sed -i '/hyphens: auto;/d' fedrq.?.html

      set +x
      if [ -z "${OAUTH2_TOKEN-}" ]
      then
        echo "Not submitting manpage build. Secrets are disabled"
        exit
      fi
      set -x
      if [ "$(git rev-parse HEAD)" = "$(git rev-parse origin/main)" ]; then
        echo "Submitting build for main branch"
        site="fedrq"
      elif [ "$(git rev-parse HEAD)" = "$(git rev-parse origin/_dev)" ]; then
        echo "Submitting build for _dev branch"
        site="fedrq_dev"
      else
        echo "Not submitting manpage build. Branch is not main or _dev."
        exit
      fi

      tar czvf fedrq.tar.gz *.html
      hut pages publish fedrq.tar.gz -d gotmax23.srht.site -s "${site}"
  - setup-venv: |
      cd fedrq
      python3 -m venv venv
      ./venv/bin/pip install nox
  - lint: |
      cd fedrq
      $nox -e lint -- --check
  - pytest: |
      cd fedrq
      FEDRQ_BACKEND=dnf $nox -e test -- -v
      FEDRQ_BACKEND=libdnf5 $nox -e test -- -v
